autonumber

actor 利用者
利用者 -> EvaluationView : 実行ボタン押下

activate EvaluationView
  EvaluationView -> EvaluationsController : execute

  activate EvaluationsController
    EvaluationController -> EvaluationController : check_invalid_param

    opt 不正なパラメーターがない
      create Evaluation
      EvaluationsController -> Evaluation : new
      EvaluationsController -> Evaluation : save

      opt ファイル or テキストを選択した場合
        EvaluationController -> File : puts
      end

      EvaluationsController ->> EvaluationJob : perform_later
      activate EvaluationJob

      autonumber stop
      EvaluationView <-- EvaluationsController
    end
  deactivate EvaluationsController

  利用者 <-- EvaluationView
deactivate EvaluationView

autonumber resume
EvaluationJob -> Evaluation : find
EvaluationJob -> Evaluation : fetch_data!

activate Evaluation
  alt Top20 を選択
    Evaluation -> NetkeibaClient : http_get_race_top
  else ランダムを選択
    Evaluation -> "Denebola::Race" : where
  else
    Evaluation -> File : read
  end

  loop レースIDごとに繰り返し
    Evaluation -> "Denebola::Race" : find_by
    Evaluation -> "Evaluation::Datum" : create!
  end
deactivate Evaluation

loop 評価データごとに繰り返し
  EvaluationJob -> FeatureUtil : create_feature

  activate FeatureUtil
    FeatureUtil -> "Denebola::Feature" : where
  deactivate FeatureUtil

  EvaluationJob -> YAML : dump
  EvaluationJob -> ApplicationJob : execute_script
  EvaluationJob -> "Evaluation::Datum" : import_prediction_results

  activate "Evaluation::Datum"
    "Evaluation::Datum" -> YAML : load_file

    loop レースのエントリーの数だけ繰り返す
      "Evaluation::Datum" -> "Prediction::Result" : create!
    end
  deactivate "Evaluation::Datum"
end

EvaluationJob -> Evaluation : calculate_precision!
EvaluationJob -> Evaluation : update!
deactivate EvaluationJob
