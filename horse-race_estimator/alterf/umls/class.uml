class AnalysisView <<Boundary>>
class PredictionView <<Boundary>>
class EvaluationView <<Boundary>>
class EvaluationResultView <<Boundary>>

class AnalysesController {
  + manage(request : Object) : Object
  + execute(request : Object) : Object
  - execute_params() : Hash<String, Object>
}

class PredictionsController {
  + manage(request : Object) : Object
  + execute(request : Object) : Object
  - execute_params() : Hash<String, Object>
  - check_invalid_file_params() : void
  - save_files(prediction_id : Integer) : void
}

class EvaluationsController {
  + manage(request : Object) : Object
  + execute(request : Object) : Object
  + show(request : Object) : Object
  - check_invalid_param() : void
  - user_specified_data? : Boolean
  - num_data() : Integer
  - race_ids() : Array<String>
  - execute_param() : Hash<String, Object>
}

class AnalysisJob {
  + perform(analysis_id : Integer)
}

class PredictionJob {
  + perform(prediction_id : Integer)
}

class EvaluationJob {
  + perform(evaluation_id : Integer)
}

class AnalysisMailer {
  + completed(analysis : Analysis)
  + error(analysis : Analysis)
}

class Analysis {
  - analysis_id : String
  - num_data : Integer
  - num_tree : Integer
  - num_feature : Integer
  - num_entry : Integer
  - state : String
}

class Prediction {
  - model : String
  - test_data : String
  - results: Array<PredictionResult>
  - state : String
  + set_analysis!() : void
  + import_results(result_file : String) : void
}

class PredictionResult {
  - number : Integer
  - won : Boolean
}

class Evaluation {
  - evaluation_id : String
  - model : String
  - data_source : String
  - num_data : Integer
  - data : Array<"Evaluation::Datum">
  - state : String
  - precision : Double
  - recall : Double
  - f_measure : Double
  + set_analysis!() : void
  + fetch_data!() : Array<String>
  + calculate!() : void
  - remote?() : Boolean
  - set_default_num_data() : void
  - sample_race_ids() : Array<String>
  - true_positive() : Double
  - false_positive() : Double
  - false_negative() : Double
}

class "Evaluation::Datum" {
  - race_id : String
  - race_name : String
  - race_url : String
  - prediction_results : Array<PredictionResult>
  - ground_truth : Integer
  + import_prediction_results(result_file : String) : void
}

class NetkeibaClient {
  + http_get_race_top() : Array<String>
  + http_get_race(path : String) : Hash<String, Object>
  + http_get_horse(path : String) : Hash<String, Object>
  + http_get_jockey(path : String) : Hash<String, Object>
  - send_request(path : String) : Object
}

class FeatureExtractor <<module>> {
  + extract_race(place : Object, race_data : Object, race_date : Object) : Hash<String, Object>
  + extract_entries(race_data : Object) : Hash<String, Object>
  + extract_horse(table : Object) : Hash<String, Object>
  + extract_horse_results(table : Object) : Hash<String, Object>
  + extract_jockey_results(table : Object) : Hash<String, Object>
}

class FeatureUtil {
  + {static} create_feature_from_netkeiba(race_path : String) : Hash<String, Object>
  + {static} create_feature_from_denebola(race_id : String) : Hash<String, Object>
}

class ModelUtil <<module>> {
  + unzip_model(zip_path : String, output_dir : String) : void
  + read_analysis_id(metadata_file : String) : String
}

ブラウザ -- AnalysisView
ブラウザ -- PredictionView
ブラウザ -- EvaluationView
ブラウザ -- EvaluationResultView

AnalysisView -- AnalysesController
AnalysesController --> AnalysisJob
AnalysisJob --> AnalysisMailer
AnalysesController "1" -- "1" Analysis
AnalysisJob "1" -- "1" Analysis
Analysis "1" -- "0 .. *" Prediction
Analysis "1" -- "0 .. *" Evaluation

PredictionView -- PredictionsController
PredictionsController --> PredictionJob
PredictionsController "1" -- "1" Prediction
PredictionJob "1" -- "1" Prediction
PredictionJob --> FeatureUtil
PredictionJob ..> ModelUtil : <<include>>
Prediction "1" -- "*" PredictionResult
Prediction ..> ModelUtil : <<include>>

EvaluationView -- EvaluationsController
EvaluationsController --> EvaluationJob
EvaluationsController "1" -- "1" Evaluation
EvaluationJob --> FeatureUtil
EvaluationJob ..> ModelUtil : <<include>>
EvaluationJob "1" -- "1" Evaluation
Evaluation "1" -- "1 .. *" "Evaluation::Datum"
Evaluation ..> ModelUtil : <<include>>
"Evaluation::Datum" "1" -- "*" PredictionResult

EvaluationResultView -- EvaluationsController

FeatureUtil --> NetkeibaClient
NetkeibaClient ..> FeatureExtractor : <<include>>
