autonumber

loop 指定された期間内を日付ごとに繰り返し
  extract -> File : read

  loop レースIDごとに繰り返し
    extract -> File : read
    extract -> "Nokogiri::HTML" : parse
    extract -> "extract/race" : extract_race
    extract -> Race : find_by

    alt 抽出したレース情報が存在する
      opt operation == 'update' or 'upsert'
        extract -> Race : update!
      end
    else
      opt operation == 'create' or 'upsert'
        extract -> Race :create!
      end
    end

    loop エントリーごとに繰り返し
      extract -> "extract/entry" : extract_entry
      extract -> Entry : find_by

      alt 抽出したエントリー情報が存在する
        opt operation == 'update' or 'upsert'
          extract -> Entry : update!
        end
      else
        opt operation == 'create' or 'upsert'
          extract -> Entry : create!
        end
      end

      extract -> Jockey : find_by

      alt 抽出した騎手情報が存在する
        opt operation == 'update' or 'upsert'
          extract -> Jockey : update!
        end
      else
        opt operation == 'create' or 'upsert'
          extract -> Jockey : create!
        end
      end

      extract -> Jockey : results
      activate Jockey
        Jockey -> Entry : <<
      deactivate Jockey

      extract -> File : read
      extract -> "Nokogiri::HTML" : parse
      extract -> "extract/horse" : extract_horse
      extract -> Horse : find_by

      alt 抽出した競走馬情報が存在する
        opt operation == 'update' or 'upsert'
          extract -> Horse : update!
        end
      else
        opt operation == 'create' or 'upsert'
          extract -> Horse : create!
        end
      end

      extract -> Horse : results
      activate Horse
        Horse -> Entry : <<
      deactivate Jockey
    end

    extract -> "extract/payoff" : extract_payoff
    extract -> Race : create_payoff
  end
end
