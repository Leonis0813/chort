autonumber

loop for each date
  alt レースIDファイルが存在する
    collect -> File : read
  else
    collect -> HTTPClient : get

    autonumber stop
    collect <-- HTTPClient

    autonumber resume
    collect -> File : write
  end

  loop レースIDごとに繰り返し
    alt レース情報ファイルが存在する
      collect -> File : read
    else
      collect -> HTTPClient : get

      autonumber stop
      collect <-- HTTPClient

      autonumber resume
      collect -> File : write
    end

    collect -> Nokogiri::HTML : parse
    autonumber stop
    collect <-- Nokogiri::HTML : parsed_html

    autonumber resume
    collect -> collect : extract_race_info

    create Race
    collect -> Race : find_or_create_by!

    autonumber stop
    collect <-- Race : race

    loop レースのエントリーごとに繰り返し
      autonumber resume
      create Entry
      collect -> Entry : find_or_create_by!

      autonumber stop
      collect <-- Entry : entry

      autonumber resume
      create Result
      collect -> Result : find_or_create_by!

      alt 競走馬情報が存在しない
        alt 競走馬情報ファイルが存在する
          collect : File : read
        else
          collect -> HTTPClient : get

          autonumber stop
          collect <-- HTTPClient

          autonumber resume
          collect -> File : write
        end
        create Horse
        collect -> Horse : create!
      end
    end
  end
end
