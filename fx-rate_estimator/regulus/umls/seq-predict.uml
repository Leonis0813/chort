autonumber

actor 利用者
利用者 -> PredictionView : 実行ボタン押下

activate PredictionView
  PredictionView -> PredictionsController : execute

  activate PredictionsController
    PredictionsController -> ApplicationController : check_absent_params

    create Prediction
    PredictionsController -> Prediction : new

    PredictionsController -> ModelUtil : output_model
    PredictionsController ->> PredictionJob : perform_later
    activate PredictionJob

    autonumber stop
    PredictionView <-- PredictionsController
  deactivate PredictionsController

  利用者 <-- PredictionView
deactivate PredictionView

autonumber resume
PredictionJob -> Prediction : find
PredictionJob -> Prediction : start!

activate Prediction
  Prediction -> ActionCable : bloadcast

  activate ActionCable
    autonumber stop
    PredictionView <<- ActionCable : メッセージ送信
    Prediction <-- ActionCable
  deactivate ActionCable

  PredictionJob <-- Prediction
deactivate Prediction

autonumber resume
PredictionJob -> ModelUtil : unzip_model
PredictionJob -> Prediction : set_analysis!

activate Prediction
  Prediction -> YAML : load_file
  Prediction -> Analysis : find_by
  Prediction -> Prediction : update!
  Prediction -> ActionCable : bloadcast

  activate ActionCable
    autonumber stop
    PredictionView <<- ActionCable : メッセージ送信
    Prediction <-- ActionCable
  deactivate ActionCable

  PredictionJob <-- Prediction
deactivate Prediction

autonumber resume
PredictionJob -> YAML : dump

alt 最新のデータを利用 and 自動予測
  PredictionJob -> PredictionJob : polling_zosma
  PredictionJob -> "Zosma::CandleStick" : exists?
  PredictionJob -> "Zosma::MovingAverage" : exists?
end

PredictionJob -> PredictionJob : execute_script
PredictionJob -> Prediction : import_result!

activate Prediction
  Prediction -> YAML : load_file
  Prediction -> Prediction : update!
  Prediction -> ActionCable : bloadcast

  activate ActionCable
    autonumber stop
    PredictionView <<- ActionCable : メッセージ送信
    Prediction <-- ActionCable
  deactivate ActionCable

  PredictionJob <-- Prediction
deactivate Prediction

autonumber resume
PredictionJob -> Prediction : completed!

activate Prediction
  Prediction -> ActionCable : bloadcast

  activate ActionCable
    autonumber stop
    PredictionView <<- ActionCable : メッセージ送信
    Prediction <-- ActionCable
  deactivate ActionCable

  PredictionJob <-- Prediction
deactivate Prediction

deactivate PredictionJob
