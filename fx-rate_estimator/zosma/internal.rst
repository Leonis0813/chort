設計仕様
========

設計仕様では以下を定義する

- :ref:`zos-int-cls`
- :ref:`zos-int-seq`
- :ref:`zos-int-sch`

.. _zos-int-cls:

モジュール構成
--------------

*クラス図*

.. uml:: umls/class.uml

- Rate

  - レートを表すクラス

- CandleStick

  - ローソク足を表すクラス

.. _zos-int-seq:

シーケンス
----------

- :ref:`zos-int-seq-import-rates`
- :ref:`zos-int-seq-import-candle-sticks`

.. _zos-int-seq-import-rates:

レートを収集する
^^^^^^^^^^^^^^^^

*シーケンス図*

.. uml:: umls/seq-import-rates.uml

指定された収集開始日と収集終了日から計算した収集月ごとに1を繰り返す

1. バックアップディレクトリから対象月の圧縮ファイルを取得して解凍する

指定された収集開始日と収集終了日から計算した収集日ごとに以下を繰り返す

2. 外部ツール，または解凍したバックアップファイルから対象日のファイルを取得する

   - ファイルにはリアルタイムで日付・ペアごとにレートが出力されている
   - 1行に1レートが日時の順番で記載されている

取得したファイル数分，3, 4を繰り返す

3. ファイルに記載されているレート情報を成形して一時ファイルに書き込む
4. 書き込んだ一時ファイルをDBにインポートする
5. DBから日時を指定してレートを取得する

レートが存在していて，かつ取得したファイルがバックアップファイルでなければ6を実行する

6. DBに登録したレートをファイルに出力する

   - 1日分の全てのペアのレートを日時の順番で1ファイルに出力する

- 収集開始日と終了日を指定可能

  - 日付はyyyy-mm-ddの形式で指定する

- 指定がない場合は以下に従う

  - 収集開始日: 実行した日の2日前
  - 収集終了日: 実行した日の2日前

- 実行例

  .. code-block:: none

     bundle exec ruby import/rates.rb --from=2018-01-01 --to=2018-01-31

.. _zos-int-seq-import-candle-sticks:

ローソク足を収集する
^^^^^^^^^^^^^^^^^^^^

*シーケンス図*

.. uml:: umls/seq-import-candle-sticks.uml

指定された収集開始日と収集終了日から計算した収集月ごとに1を繰り返す

1. バックアップディレクトリから対象月の圧縮ファイルを取得して解凍する

指定された収集開始日と収集終了日から計算した収集日ごとに以下を繰り返す

2. 外部ツール，または解凍したバックアップファイルから対象日のファイルを取得する

   - ファイルにはローソク足情報として1分ごとに以下の情報が出力されている

     - 開始日時
     - 終了日時
     - 通貨ペア
     - 期間
     - 始値
     - 終値
     - 高値
     - 安値

   - 1行に1本のローソク足情報が終了日時，期間の順番で記載されている
   - ファイルは通貨ペアごとに出力されている

取得したファイル数分，3, 4を繰り返す

3. ファイルに記載されているローソク足情報を成形して一時ファイルに書き込む
4. 書き込んだ一時ファイルをDBにインポートする
5. DBから日時を指定してローソク足を取得する

ローソク足が存在していて，かつ取得したファイルがバックアップファイルでなければ6を実行する

6. DBに登録したローソク足をファイルに出力する

   - 1日分の全てのペアのローソク足を日時の順番で1ファイルに出力する

- 収集開始日と終了日を指定可能

  - 日付はyyyy-mm-ddの形式で指定する

- 指定がない場合は以下に従う

  - 収集開始日: 実行した日の2日前
  - 収集終了日: 実行した日の2日前

- 実行例

  .. code-block:: none

     bundle exec ruby import/candle_sticks.rb --from=2018-01-01 --to=2018-01-31

.. _zos-int-sch:

スキーマ定義
------------

- :ref:`zos-int-sch-rates`
- :ref:`zos-int-sch-candle-sticks`

.. _zos-int-sch-rates:

ratesテーブル
^^^^^^^^^^^^^

レートを登録するratesテーブルを定義する

.. csv-table::
   :header: "カラム", "型", "内容", "PRIMARY KEY", "NOT NULL"
   :widths: 10, 10, 20, 20, 10

   "id", "INTEGER", "レートのID", "○", "○"
   "time", "DATETIME", "レートが変化した日時",,"○"
   "pair", "STRING", "レートのペア",,"○"
   "bid", "FLOAT", "売値",,"○"
   "ask", "FLOAT", "買値",,"○"
   "created_at", "DATETIME", "作成日時",,"○"
   "updated_at", "DATETIME", "更新日時",,"○"

.. _zos-int-sch-candle-sticks:

candle_sticksテーブル
^^^^^^^^^^^^^^^^^^^^^

ローソク足を登録するcandle_sticksテーブルを定義する

.. csv-table::
   :header: "カラム", "型", "内容", "PRIMARY KEY", "NOT NULL"
   :widths: 10, 10, 20, 20, 10

   "id", "INTEGER", "レートのID", "○", "○"
   "from", "DATETIME", "ローソク足の開始日時",, "○"
   "to", "DATETIME", "ローソク足の終了日時",, "○"
   "pair", "STRING", "レートのペア",, "○"
   "period", "STRING", "期間を示すID",, "○"
   "open", "FLOAT", "始値",, "○"
   "close", "FLOAT", "終値",, "○"
   "high", "FLOAT", "高値",, "○"
   "low", "FLOAT", "安値",, "○"
   "created_at", "DATETIME", "作成日時",,"○"
   "updated_at", "DATETIME", "更新日時",,"○"
